<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTM-Reisebescheinigung Artikel 75</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            overflow-x: auto;
        }
        
        .nav-tab {
            padding: 15px 30px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            color: #495057;
            transition: all 0.3s;
            white-space: nowrap;
            position: relative;
        }
        
        .nav-tab:hover {
            background: #e9ecef;
        }
        
        .nav-tab.active {
            color: #667eea;
            background: white;
        }
        
        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: #667eea;
        }
        
        .content {
            padding: 30px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-secondary {
            background: #f8f9fa;
            color: #495057;
            border: 2px solid #dee2e6;
        }
        
        .btn-secondary:hover {
            background: #e9ecef;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            color: white;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .medication-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
            transition: all 0.3s;
        }
        
        .medication-item:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
        }
        
        .medication-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .medication-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        
        .dosage-scheme {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid #e0e0e0;
        }
        
        .dosage-scheme-item {
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .dosage-input-group {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .dosage-label {
            text-align: center;
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .pdf-download-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }
        
        .pdf-item {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            min-width: 250px;
            transition: all 0.3s;
        }
        
        .pdf-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
        }
        
        @media print {
            body { display: none; }
        }
        
        .medication-plan {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .medication-plan h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
        }
        
        .medication-plan table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .medication-plan th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-size: 14px;
        }
        
        .medication-plan td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 14px;
        }
        
        .medication-plan tr:hover {
            background: #f8f9fa;
        }
        
        .saved-data-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .saved-data-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e9ecef;
            transition: all 0.3s;
        }
        
        .saved-data-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
        }
        
        .saved-data-card h4 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .saved-data-card p {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .alert-info {
            background: #e3f2fd;
            color: #1976d2;
            border-left: 4px solid #1976d2;
        }
        
        .alert-success {
            background: #e8f5e9;
            color: #388e3c;
            border-left: 4px solid #388e3c;
        }
        
        .alert-warning {
            background: #fff3e0;
            color: #f57c00;
            border-left: 4px solid #f57c00;
        }
        
        .manual-medication-form {
            background: #f0f0f0;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        @media print {
            body {
                background: white;
                padding: 0;
            }
            
            .container {
                box-shadow: none;
                border-radius: 0;
            }
            
            .header, .nav-tabs, .button-group, .content > *:not(#certificates-tab) {
                display: none !important;
            }
            
            #certificates-tab {
                display: block !important;
            }
            
            .certificate-preview {
                border: none;
                margin: 0;
                padding: 15mm;
                page-break-after: always;
            }
            
            @page {
                size: A4;
                margin: 0;
            }
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            color: #333;
        }
        
        .close-modal {
            float: right;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
        
        .close-modal:hover {
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>BTM-Reisebescheinigung Generator</h1>
            <p>Artikel 75 des Schengener Durchf√ºhrungsabkommens</p>
        </div>
        
        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="patient">üë§ Patient</button>
            <button class="nav-tab" data-tab="doctor">‚öïÔ∏è Arzt</button>
            <button class="nav-tab" data-tab="medication">üíä Medikamente</button>
            <button class="nav-tab" data-tab="travel">‚úàÔ∏è Reisedaten</button>
            <button class="nav-tab" data-tab="certificates">üìÑ Formulare</button>
            <button class="nav-tab" data-tab="data">üíæ Gespeicherte Daten</button>
        </div>
        
        <div class="content">
            <!-- Patient Tab -->
            <div class="tab-content active" id="patient-tab">
                <h2>Patientendaten</h2>
                <div class="alert alert-info">
                    ‚ÑπÔ∏è Bitte geben Sie die pers√∂nlichen Daten des Patienten ein
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="patient-lastname">Nachname *</label>
                        <input type="text" id="patient-lastname" required>
                    </div>
                    <div class="form-group">
                        <label for="patient-firstname">Vorname *</label>
                        <input type="text" id="patient-firstname" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="patient-passport">Pass-/Ausweisnummer *</label>
                        <input type="text" id="patient-passport" required>
                    </div>
                    <div class="form-group">
                        <label for="patient-birthplace">Geburtsort *</label>
                        <input type="text" id="patient-birthplace" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="patient-birthdate">Geburtsdatum *</label>
                        <input type="date" id="patient-birthdate" required>
                    </div>
                    <div class="form-group">
                        <label for="patient-nationality">Staatsangeh√∂rigkeit *</label>
                        <input type="text" id="patient-nationality" value="Deutsch">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="patient-gender">Geschlecht *</label>
                        <select id="patient-gender" required>
                            <option value="">Bitte w√§hlen</option>
                            <option value="m√§nnlich">M√§nnlich</option>
                            <option value="weiblich">Weiblich</option>
                            <option value="divers">Divers</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="patient-street">Stra√üe und Hausnummer *</label>
                        <input type="text" id="patient-street" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="patient-zip">PLZ *</label>
                        <input type="text" id="patient-zip" required>
                    </div>
                    <div class="form-group">
                        <label for="patient-city">Stadt *</label>
                        <input type="text" id="patient-city" required>
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-primary" onclick="savePatientData()">
                        üíæ Patientendaten speichern
                    </button>
                    <button class="btn btn-secondary" onclick="showSavedPatients()">
                        üìÇ Gespeicherten Patienten laden
                    </button>
                </div>
            </div>
            
            <!-- Doctor Tab -->
            <div class="tab-content" id="doctor-tab">
                <h2>Arztdaten</h2>
                <div class="alert alert-info">
                    ‚ÑπÔ∏è Arzt basierend auf Patientenadresse suchen oder manuell eingeben
                </div>
                
                <div class="button-group">
                    <button class="btn btn-primary" onclick="searchDoctor()">
                        üîç Arzt in der N√§he suchen
                    </button>
                    <button class="btn btn-secondary" onclick="showSavedDoctors()">
                        üìÇ Gespeicherten Arzt laden
                    </button>
                </div>
                
                <div class="form-row" style="margin-top: 20px;">
                    <div class="form-group">
                        <label for="doctor-title">Titel</label>
                        <input type="text" id="doctor-title" value="Dr. med.">
                    </div>
                    <div class="form-group">
                        <label for="doctor-lastname">Nachname *</label>
                        <input type="text" id="doctor-lastname" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="doctor-firstname">Vorname *</label>
                        <input type="text" id="doctor-firstname" required>
                    </div>
                    <div class="form-group">
                        <label for="doctor-phone">Telefon *</label>
                        <input type="tel" id="doctor-phone" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="doctor-address">Praxisadresse *</label>
                    <input type="text" id="doctor-address" required>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-primary" onclick="saveDoctorData()">
                        üíæ Arztdaten speichern
                    </button>
                    <button class="btn btn-success" onclick="linkPatientDoctor()">
                        üîó Mit aktuellem Patienten verkn√ºpfen
                    </button>
                </div>
            </div>
            
            <!-- Medication Tab -->
            <div class="tab-content" id="medication-tab">
                <h2>Medikamente</h2>
                <div class="alert alert-info">
                    ‚ÑπÔ∏è F√ºgen Sie die ben√∂tigten Bet√§ubungsmittel hinzu
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="medication-search">Medikament suchen</label>
                        <input type="text" id="medication-search" placeholder="z.B. Ritalin, Medikinet, Elvanse...">
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button class="btn btn-primary" onclick="searchMedication()">
                            üîç Suchen
                        </button>
                    </div>
                </div>
                
                <div id="medication-search-results"></div>
                
                <!-- Manual medication entry -->
                <div class="manual-medication-form">
                    <h4>Medikament manuell hinzuf√ºgen</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="manual-med-name">Handelsname *</label>
                            <input type="text" id="manual-med-name" placeholder="z.B. Ritalin Adult">
                        </div>
                        <div class="form-group">
                            <label for="manual-med-form">Darreichungsform *</label>
                            <select id="manual-med-form">
                                <option value="Tablette">Tablette</option>
                                <option value="Kapsel">Kapsel</option>
                                <option value="Retardkapsel">Retardkapsel</option>
                                <option value="Retardtablette">Retardtablette</option>
                                <option value="Tropfen">Tropfen</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="manual-med-substance">Wirkstoff *</label>
                            <input type="text" id="manual-med-substance" placeholder="z.B. Methylphenidat">
                        </div>
                        <div class="form-group">
                            <label for="manual-med-concentration">Konzentration *</label>
                            <input type="text" id="manual-med-concentration" placeholder="z.B. 10mg">
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="addManualMedication()">
                        ‚ûï Manuell hinzuf√ºgen
                    </button>
                </div>
                
                <h3 style="margin-top: 30px;">Ausgew√§hlte Medikamente</h3>
                <div id="selected-medications"></div>
            </div>
            
            <!-- Travel Tab -->
            <div class="tab-content" id="travel-tab">
                <h2>Reisedaten & Einnahmeschemata</h2>
                <div class="alert alert-info">
                    ‚ÑπÔ∏è Geben Sie die Reisedaten und Einnahmeschemata in Dreier-Notation ein
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="travel-start">Abreisedatum *</label>
                        <input type="date" id="travel-start" required onchange="updateTravelDuration()">
                    </div>
                    <div class="form-group">
                        <label for="travel-end">R√ºckreisedatum *</label>
                        <input type="date" id="travel-end" required onchange="updateTravelDuration()">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="travel-duration">Reisedauer (Tage)</label>
                        <input type="number" id="travel-duration" readonly>
                    </div>
                    <div class="form-group">
                        <label for="travel-destination">Reiseziel</label>
                        <input type="text" id="travel-destination" placeholder="z.B. Spanien, Italien...">
                    </div>
                </div>
                
                <h3 style="margin-top: 30px;">Einnahmeschemata</h3>
                <div id="dosage-schemes"></div>
            </div>
            
            <!-- Certificates Tab -->
            <div class="tab-content" id="certificates-tab">
                <h2>Formulare & Medikationsplan</h2>
                <div class="alert alert-info">
                    ‚ÑπÔ∏è Generieren Sie PDFs f√ºr alle Formulare und den Medikationsplan
                </div>
                
                <div class="button-group">
                    <button class="btn btn-primary" onclick="generatePDFs()">
                        üìÑ PDFs generieren
                    </button>
                    <button class="btn btn-success" onclick="downloadAllPDFs()">
                        üíæ Alle PDFs herunterladen
                    </button>
                    <button class="btn btn-secondary" onclick="exportData()">
                        üì§ Daten exportieren
                    </button>
                </div>
                
                <div id="certificates-container" style="margin-top: 30px;"></div>
                <div id="medication-plan-container"></div>
            </div>
            
            <!-- Data Management Tab -->
            <div class="tab-content" id="data-tab">
                <h2>Datenverwaltung</h2>
                <div class="alert alert-info">
                    ‚ÑπÔ∏è Verwalten Sie gespeicherte Patienten, √Ñrzte und Verkn√ºpfungen
                </div>
                
                <div class="button-group">
                    <button class="btn btn-primary" onclick="exportAllData()">
                        üì§ Alle Daten exportieren
                    </button>
                    <button class="btn btn-secondary" onclick="importData()">
                        üì• Daten importieren
                    </button>
                    <button class="btn btn-danger" onclick="clearAllData()">
                        üóëÔ∏è Alle Daten l√∂schen
                    </button>
                </div>
                
                <h3 style="margin-top: 30px;">Gespeicherte Patienten</h3>
                <div id="saved-patients" class="saved-data-list"></div>
                
                <h3 style="margin-top: 30px;">Gespeicherte √Ñrzte</h3>
                <div id="saved-doctors" class="saved-data-list"></div>
                
                <h3 style="margin-top: 30px;">Verkn√ºpfungen</h3>
                <div id="saved-links" class="saved-data-list"></div>
            </div>
        </div>
    </div>
    
    <!-- Hidden file input for import -->
    <input type="file" id="import-file" style="display: none;" accept=".json" onchange="handleImport(event)">
    
    <script>
        // Global data storage
        let appData = {
            patients: [],
            doctors: [],
            medications: [],
            selectedMedications: [],
            patientDoctorLinks: [],
            currentPatient: null,
            currentDoctor: null,
            travelData: null,
            dosageSchemes: {}
        };
        
        // Extended medication database including Ritalin Adult
        const medicationDatabase = [
            // Methylphenidate preparations
            { name: "Ritalin", form: "Tablette", substance: "Methylphenidat", concentrations: ["5mg", "10mg", "20mg"] },
            { name: "Ritalin Adult", form: "Kapsel", substance: "Methylphenidat", concentrations: ["10mg", "20mg", "30mg", "40mg", "60mg"] },
            { name: "Ritalin LA", form: "Retardkapsel", substance: "Methylphenidat", concentrations: ["10mg", "20mg", "30mg", "40mg"] },
            { name: "Medikinet", form: "Tablette", substance: "Methylphenidat", concentrations: ["5mg", "10mg", "20mg"] },
            { name: "Medikinet adult", form: "Retardkapsel", substance: "Methylphenidat", concentrations: ["5mg", "10mg", "20mg", "30mg", "40mg", "50mg", "60mg"] },
            { name: "Concerta", form: "Retardtablette", substance: "Methylphenidat", concentrations: ["18mg", "27mg", "36mg", "54mg"] },
            { name: "Equasym", form: "Tablette", substance: "Methylphenidat", concentrations: ["5mg", "10mg", "20mg"] },
            { name: "Equasym Retard", form: "Retardkapsel", substance: "Methylphenidat", concentrations: ["10mg", "20mg", "30mg"] },
            { name: "Kinecteen", form: "Retardtablette", substance: "Methylphenidat", concentrations: ["18mg", "27mg", "36mg", "54mg"] },
            
            // Lisdexamfetamine
            { name: "Elvanse", form: "Kapsel", substance: "Lisdexamfetamin", concentrations: ["20mg", "30mg", "40mg", "50mg", "60mg", "70mg"] },
            { name: "Elvanse Adult", form: "Kapsel", substance: "Lisdexamfetamin", concentrations: ["30mg", "50mg", "70mg"] },
            
            // Dexamfetamine
            { name: "Attentin", form: "Tablette", substance: "Dexamfetamin", concentrations: ["5mg", "10mg", "20mg"] },
            
            // Atomoxetine (not BTM but often used)
            { name: "Strattera", form: "Kapsel", substance: "Atomoxetin", concentrations: ["10mg", "18mg", "25mg", "40mg", "60mg", "80mg", "100mg"] },
            
            // Guanfacine (not BTM but often used)
            { name: "Intuniv", form: "Retardtablette", substance: "Guanfacin", concentrations: ["1mg", "2mg", "3mg", "4mg"] }
        ];
        
        // Initialize dosage schemes storage
        function initDosageScheme(medicationId) {
            if (!appData.dosageSchemes[medicationId]) {
                appData.dosageSchemes[medicationId] = [];
            }
        }
        
        // Tab switching
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabName = this.getAttribute('data-tab');
                
                // Update active tab
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // Update active content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${tabName}-tab`).classList.add('active');
            });
        });
        
        // Patient functions
        function savePatientData() {
            const patient = {
                id: Date.now(),
                lastname: document.getElementById('patient-lastname').value,
                firstname: document.getElementById('patient-firstname').value,
                passport: document.getElementById('patient-passport').value,
                birthplace: document.getElementById('patient-birthplace').value,
                birthdate: document.getElementById('patient-birthdate').value,
                nationality: document.getElementById('patient-nationality').value,
                gender: document.getElementById('patient-gender').value,
                street: document.getElementById('patient-street').value,
                zip: document.getElementById('patient-zip').value,
                city: document.getElementById('patient-city').value
            };
            
            // Check if all required fields are filled
            if (!patient.lastname || !patient.firstname || !patient.passport || 
                !patient.birthplace || !patient.birthdate || !patient.gender || 
                !patient.street || !patient.zip || !patient.city) {
                alert('Bitte f√ºllen Sie alle Pflichtfelder aus!');
                return;
            }
            
            // Check if patient already exists
            const existingIndex = appData.patients.findIndex(p => 
                p.firstname === patient.firstname && 
                p.lastname === patient.lastname && 
                p.birthdate === patient.birthdate
            );
            
            if (existingIndex !== -1) {
                if (confirm('Patient existiert bereits. √úberschreiben?')) {
                    appData.patients[existingIndex] = patient;
                } else {
                    return;
                }
            } else {
                appData.patients.push(patient);
            }
            
            appData.currentPatient = patient;
            saveToStorage();
            alert('Patientendaten wurden gespeichert!');
            updateSavedDataDisplay();
        }
        
        function showSavedPatients() {
            if (appData.patients.length === 0) {
                alert('Keine gespeicherten Patienten vorhanden!');
                return;
            }
            
            let patientList = 'Gespeicherte Patienten:\n\n';
            appData.patients.forEach((patient, index) => {
                patientList += `${index + 1}. ${patient.firstname} ${patient.lastname} (${new Date(patient.birthdate).toLocaleDateString('de-DE')})\n`;
            });
            
            const selection = prompt(patientList + '\nNummer eingeben:');
            if (selection && appData.patients[selection - 1]) {
                loadPatient(appData.patients[selection - 1]);
            }
        }
        
        function loadPatient(patient) {
            document.getElementById('patient-lastname').value = patient.lastname;
            document.getElementById('patient-firstname').value = patient.firstname;
            document.getElementById('patient-passport').value = patient.passport;
            document.getElementById('patient-birthplace').value = patient.birthplace;
            document.getElementById('patient-birthdate').value = patient.birthdate;
            document.getElementById('patient-nationality').value = patient.nationality;
            document.getElementById('patient-gender').value = patient.gender;
            document.getElementById('patient-street').value = patient.street;
            document.getElementById('patient-zip').value = patient.zip;
            document.getElementById('patient-city').value = patient.city;
            
            appData.currentPatient = patient;
            alert('Patientendaten wurden geladen!');
        }
        
        // Doctor functions
        function searchDoctor() {
            if (!appData.currentPatient) {
                alert('Bitte erst Patientendaten eingeben!');
                return;
            }
            
            // Simulate doctor search based on patient location
            const mockDoctors = [
                { title: "Dr. med.", lastname: "Schmidt", firstname: "Thomas", phone: "0911/123456", address: "Hauptstra√üe 15, 90518 Altdorf bei N√ºrnberg" },
                { title: "Dr. med.", lastname: "M√ºller", firstname: "Sarah", phone: "0911/234567", address: "Bahnhofstra√üe 8, 92353 Postbauer-Heng" },
                { title: "Dr. med.", lastname: "Weber", firstname: "Michael", phone: "0911/345678", address: "Marktplatz 3, 90518 Altdorf bei N√ºrnberg" }
            ];
            
            // Randomly select a doctor
            const doctor = mockDoctors[Math.floor(Math.random() * mockDoctors.length)];
            
            document.getElementById('doctor-title').value = doctor.title;
            document.getElementById('doctor-lastname').value = doctor.lastname;
            document.getElementById('doctor-firstname').value = doctor.firstname;
            document.getElementById('doctor-phone').value = doctor.phone;
            document.getElementById('doctor-address').value = doctor.address;
            
            alert('Arzt wurde gefunden und eingetragen!');
        }
        
        function saveDoctorData() {
            const doctor = {
                id: Date.now(),
                title: document.getElementById('doctor-title').value,
                lastname: document.getElementById('doctor-lastname').value,
                firstname: document.getElementById('doctor-firstname').value,
                phone: document.getElementById('doctor-phone').value,
                address: document.getElementById('doctor-address').value
            };
            
            if (!doctor.lastname || !doctor.firstname || !doctor.phone || !doctor.address) {
                alert('Bitte f√ºllen Sie alle Pflichtfelder aus!');
                return;
            }
            
            // Check if doctor already exists
            const existingIndex = appData.doctors.findIndex(d => 
                d.firstname === doctor.firstname && 
                d.lastname === doctor.lastname
            );
            
            if (existingIndex !== -1) {
                if (confirm('Arzt existiert bereits. √úberschreiben?')) {
                    appData.doctors[existingIndex] = doctor;
                } else {
                    return;
                }
            } else {
                appData.doctors.push(doctor);
            }
            
            appData.currentDoctor = doctor;
            saveToStorage();
            alert('Arztdaten wurden gespeichert!');
            updateSavedDataDisplay();
        }
        
        function showSavedDoctors() {
            if (appData.doctors.length === 0) {
                alert('Keine gespeicherten √Ñrzte vorhanden!');
                return;
            }
            
            let doctorList = 'Gespeicherte √Ñrzte:\n\n';
            appData.doctors.forEach((doctor, index) => {
                doctorList += `${index + 1}. ${doctor.title} ${doctor.firstname} ${doctor.lastname}\n`;
            });
            
            const selection = prompt(doctorList + '\nNummer eingeben:');
            if (selection && appData.doctors[selection - 1]) {
                loadDoctor(appData.doctors[selection - 1]);
            }
        }
        
        function loadDoctor(doctor) {
            document.getElementById('doctor-title').value = doctor.title;
            document.getElementById('doctor-lastname').value = doctor.lastname;
            document.getElementById('doctor-firstname').value = doctor.firstname;
            document.getElementById('doctor-phone').value = doctor.phone;
            document.getElementById('doctor-address').value = doctor.address;
            
            appData.currentDoctor = doctor;
            alert('Arztdaten wurden geladen!');
        }
        
        function linkPatientDoctor() {
            if (!appData.currentPatient || !appData.currentDoctor) {
                alert('Bitte erst Patient und Arzt ausw√§hlen!');
                return;
            }
            
            const existingLink = appData.patientDoctorLinks.find(link =>
                link.patientId === appData.currentPatient.id &&
                link.doctorId === appData.currentDoctor.id
            );
            
            if (!existingLink) {
                appData.patientDoctorLinks.push({
                    patientId: appData.currentPatient.id,
                    doctorId: appData.currentDoctor.id
                });
                saveToStorage();
                alert('Patient und Arzt wurden verkn√ºpft!');
            } else {
                alert('Diese Verkn√ºpfung existiert bereits!');
            }
            
            updateSavedDataDisplay();
        }
        
        // Medication functions
        function searchMedication() {
            const searchTerm = document.getElementById('medication-search').value.toLowerCase();
            const combinedDatabase = [...medicationDatabase, ...appData.medications];
            const results = combinedDatabase.filter(med => 
                med.name.toLowerCase().includes(searchTerm) ||
                med.substance.toLowerCase().includes(searchTerm)
            );
            
            const resultsContainer = document.getElementById('medication-search-results');
            resultsContainer.innerHTML = '<h4>Suchergebnisse:</h4>';
            
            if (results.length === 0) {
                resultsContainer.innerHTML += '<p>Keine Medikamente gefunden.</p>';
                return;
            }
            
            results.forEach(med => {
                const medDiv = document.createElement('div');
                medDiv.className = 'medication-item';
                medDiv.innerHTML = `
                    <div class="medication-header">
                        <span class="medication-title">${med.name} (${med.substance})</span>
                        <span>${med.form}</span>
                    </div>
                    <div class="form-row">
                        ${med.concentrations.map(conc => `
                            <button class="btn btn-secondary btn-small" onclick="addMedication('${med.name}', '${med.form}', '${med.substance}', '${conc}')">
                                + ${conc}
                            </button>
                        `).join('')}
                    </div>
                `;
                resultsContainer.appendChild(medDiv);
            });
        }
        
        function addManualMedication() {
            const name = document.getElementById('manual-med-name').value;
            const form = document.getElementById('manual-med-form').value;
            const substance = document.getElementById('manual-med-substance').value;
            const concentration = document.getElementById('manual-med-concentration').value;
            
            if (!name || !form || !substance || !concentration) {
                alert('Bitte alle Felder ausf√ºllen!');
                return;
            }
            
            // Add to database for future use
            const existingMed = appData.medications.find(m => m.name === name);
            if (existingMed) {
                if (!existingMed.concentrations.includes(concentration)) {
                    existingMed.concentrations.push(concentration);
                }
            } else {
                appData.medications.push({
                    name: name,
                    form: form,
                    substance: substance,
                    concentrations: [concentration]
                });
            }
            
            // Add to selected medications
            addMedication(name, form, substance, concentration);
            
            // Clear form
            document.getElementById('manual-med-name').value = '';
            document.getElementById('manual-med-concentration').value = '';
            
            saveToStorage();
        }
        
        function addMedication(name, form, substance, concentration) {
            const medication = {
                id: Date.now() + Math.random(),
                name: name,
                form: form,
                substance: substance,
                concentration: concentration
            };
            
            appData.selectedMedications.push(medication);
            initDosageScheme(medication.id);
            updateSelectedMedications();
            updateDosageSchemes();
            alert(`${name} ${concentration} wurde hinzugef√ºgt!`);
        }
        
        function updateSelectedMedications() {
            const container = document.getElementById('selected-medications');
            
            if (appData.selectedMedications.length === 0) {
                container.innerHTML = '<p>Noch keine Medikamente ausgew√§hlt.</p>';
                return;
            }
            
            container.innerHTML = appData.selectedMedications.map(med => `
                <div class="medication-item">
                    <div class="medication-header">
                        <span class="medication-title">${med.name} ${med.concentration}</span>
                        <button class="btn btn-danger btn-small" onclick="removeMedication(${med.id})">
                            üóëÔ∏è Entfernen
                        </button>
                    </div>
                    <p>Wirkstoff: ${med.substance} | Form: ${med.form}</p>
                </div>
            `).join('');
        }
        
        function removeMedication(id) {
            appData.selectedMedications = appData.selectedMedications.filter(med => med.id !== id);
            delete appData.dosageSchemes[id];
            updateSelectedMedications();
            updateDosageSchemes();
        }
        
        // Travel data functions
        function updateTravelDuration() {
            const startDate = new Date(document.getElementById('travel-start').value);
            const endDate = new Date(document.getElementById('travel-end').value);
            
            if (startDate && endDate && endDate >= startDate) {
                const duration = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                document.getElementById('travel-duration').value = duration;
                
                if (duration > 30) {
                    alert('Achtung: Die maximale G√ºltigkeitsdauer betr√§gt 30 Tage!');
                }
                
                appData.travelData = {
                    start: document.getElementById('travel-start').value,
                    end: document.getElementById('travel-end').value,
                    duration: Math.min(duration, 30),
                    destination: document.getElementById('travel-destination').value
                };
                
                updateDosageSchemes();
            }
        }
        
        function updateDosageSchemes() {
            const container = document.getElementById('dosage-schemes');
            
            if (appData.selectedMedications.length === 0) {
                container.innerHTML = '<p>Bitte erst Medikamente ausw√§hlen.</p>';
                return;
            }
            
            if (!appData.travelData) {
                container.innerHTML = '<p>Bitte erst Reisedaten eingeben.</p>';
                return;
            }
            
            container.innerHTML = appData.selectedMedications.map(med => {
                const schemes = appData.dosageSchemes[med.id] || [];
                
                return `
                    <div class="medication-item">
                        <h4>${med.name} ${med.concentration}</h4>
                        <div class="dosage-scheme">
                            <div id="schemes-${med.id}">
                                ${schemes.length === 0 ? 
                                    renderDosageSchemeInput(med.id, 0, appData.travelData.start, appData.travelData.end) :
                                    schemes.map((scheme, index) => 
                                        renderDosageSchemeInput(med.id, index, scheme.startDate, scheme.endDate, scheme)
                                    ).join('')
                                }
                            </div>
                            <button class="btn btn-secondary btn-small" onclick="addDosageScheme(${med.id})">
                                + Weiteres Schema hinzuf√ºgen
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderDosageSchemeInput(medicationId, schemeIndex, startDate, endDate, existingScheme = null) {
            const schemeId = `${medicationId}-${schemeIndex}`;
            const scheme = existingScheme || { morning: 0, noon: 0, evening: 0, night: 0 };
            
            return `
                <div class="dosage-scheme-item" id="scheme-${schemeId}">
                    <p><strong>Schema ${schemeIndex + 1}</strong></p>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Von</label>
                            <input type="date" id="scheme-start-${schemeId}" value="${startDate}" onchange="updateScheme(${medicationId}, ${schemeIndex})">
                        </div>
                        <div class="form-group">
                            <label>Bis</label>
                            <input type="date" id="scheme-end-${schemeId}" value="${endDate}" onchange="updateScheme(${medicationId}, ${schemeIndex})">
                        </div>
                    </div>
                    <div class="dosage-input-group">
                        <div>
                            <div class="dosage-label">Morgens</div>
                            <input type="number" min="0" max="10" value="${scheme.morning}" id="dose-morning-${schemeId}" onchange="updateScheme(${medicationId}, ${schemeIndex})">
                        </div>
                        <div>
                            <div class="dosage-label">Mittags</div>
                            <input type="number" min="0" max="10" value="${scheme.noon}" id="dose-noon-${schemeId}" onchange="updateScheme(${medicationId}, ${schemeIndex})">
                        </div>
                        <div>
                            <div class="dosage-label">Abends</div>
                            <input type="number" min="0" max="10" value="${scheme.evening}" id="dose-evening-${schemeId}" onchange="updateScheme(${medicationId}, ${schemeIndex})">
                        </div>
                        <div>
                            <div class="dosage-label">Nachts</div>
                            <input type="number" min="0" max="10" value="${scheme.night}" id="dose-night-${schemeId}" onchange="updateScheme(${medicationId}, ${schemeIndex})">
                        </div>
                    </div>
                    ${schemeIndex > 0 ? `<button class="btn btn-danger btn-small" onclick="removeScheme(${medicationId}, ${schemeIndex})">Schema entfernen</button>` : ''}
                </div>
            `;
        }
        
        function addDosageScheme(medicationId) {
            const schemes = appData.dosageSchemes[medicationId] || [];
            
            // Get the last scheme's end date
            let startDate = appData.travelData.start;
            if (schemes.length > 0) {
                const lastScheme = schemes[schemes.length - 1];
                const lastEndDate = new Date(lastScheme.endDate);
                lastEndDate.setDate(lastEndDate.getDate() + 1);
                startDate = lastEndDate.toISOString().split('T')[0];
            }
            
            schemes.push({
                startDate: startDate,
                endDate: appData.travelData.end,
                morning: 0,
                noon: 0,
                evening: 0,
                night: 0
            });
            
            appData.dosageSchemes[medicationId] = schemes;
            updateDosageSchemes();
        }
        
        function updateScheme(medicationId, schemeIndex) {
            const schemeId = `${medicationId}-${schemeIndex}`;
            const scheme = {
                startDate: document.getElementById(`scheme-start-${schemeId}`).value,
                endDate: document.getElementById(`scheme-end-${schemeId}`).value,
                morning: parseInt(document.getElementById(`dose-morning-${schemeId}`).value) || 0,
                noon: parseInt(document.getElementById(`dose-noon-${schemeId}`).value) || 0,
                evening: parseInt(document.getElementById(`dose-evening-${schemeId}`).value) || 0,
                night: parseInt(document.getElementById(`dose-night-${schemeId}`).value) || 0
            };
            
            if (!appData.dosageSchemes[medicationId]) {
                appData.dosageSchemes[medicationId] = [];
            }
            
            appData.dosageSchemes[medicationId][schemeIndex] = scheme;
        }
        
        function removeScheme(medicationId, schemeIndex) {
            appData.dosageSchemes[medicationId].splice(schemeIndex, 1);
            updateDosageSchemes();
        }
        
        // Certificate generation with PDF
        let generatedPDFs = [];
        
        function generatePDFs() {
            if (!appData.currentPatient || !appData.currentDoctor || 
                appData.selectedMedications.length === 0 || !appData.travelData) {
                alert('Bitte f√ºllen Sie alle erforderlichen Daten aus!');
                return;
            }
            
            generatedPDFs = [];
            const certificatesContainer = document.getElementById('certificates-container');
            certificatesContainer.innerHTML = '<h3>Generierte PDFs:</h3><div class="pdf-download-list">';
            
            // Generate one PDF per medication
            appData.selectedMedications.forEach((med, index) => {
                const pdfName = `BTM-Bescheinigung_${med.name}_${med.concentration}.pdf`.replace(/\s+/g, '_');
                const pdf = createCertificatePDF(med);
                
                generatedPDFs.push({
                    name: pdfName,
                    pdf: pdf,
                    medication: med
                });
                
                // Create PDF item card
                const pdfItem = document.createElement('div');
                pdfItem.className = 'pdf-item';
                pdfItem.innerHTML = `
                    <h4>üìÑ ${med.name} ${med.concentration}</h4>
                    <p style="font-size: 12px; color: #666;">2 Seiten (Formular + Legende)</p>
                    <button class="btn btn-secondary btn-small" onclick="generatedPDFs[${generatedPDFs.length - 1}].pdf.save('${pdfName}')">
                        üíæ Download
                    </button>
                `;
                certificatesContainer.querySelector('.pdf-download-list').appendChild(pdfItem);
            });
            
            // Generate medication plan PDF
            const planPDF = createMedicationPlanPDF();
            const planName = `Medikationsplan_${appData.currentPatient.lastname}.pdf`.replace(/\s+/g, '_');
            
            generatedPDFs.push({
                name: planName,
                pdf: planPDF,
                isMedicationPlan: true
            });
            
            // Create medication plan card
            const planItem = document.createElement('div');
            planItem.className = 'pdf-item';
            planItem.style.background = '#e3f2fd';
            planItem.innerHTML = `
                <h4>üìã Medikationsplan</h4>
                <p style="font-size: 12px; color: #666;">Querformat mit Arztdaten</p>
                <button class="btn btn-primary btn-small" onclick="generatedPDFs[${generatedPDFs.length - 1}].pdf.save('${planName}')">
                    üíæ Download
                </button>
            `;
            certificatesContainer.querySelector('.pdf-download-list').appendChild(planItem);
            
            certificatesContainer.innerHTML += '</div>';
            
            // Add summary
            const summary = document.createElement('div');
            summary.className = 'alert alert-success';
            summary.style.marginTop = '20px';
            summary.innerHTML = `‚úÖ ${generatedPDFs.length} PDFs wurden erfolgreich generiert und k√∂nnen heruntergeladen werden.`;
            certificatesContainer.appendChild(summary);
            
            // Switch to certificates tab
            document.querySelector('[data-tab="certificates"]').click();
            
            alert(`${generatedPDFs.length} PDFs wurden erfolgreich generiert!`);
        }
        
        function createCertificatePDF(medication) {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            // Calculate dosage information
            const schemes = appData.dosageSchemes[medication.id] || [{
                startDate: appData.travelData.start,
                endDate: appData.travelData.end,
                morning: 0,
                noon: 0,
                evening: 0,
                night: 0
            }];
            
            let totalAmount = 0;
            let dosageInstructions = [];
            
            schemes.forEach(scheme => {
                const startDate = new Date(scheme.startDate);
                const endDate = new Date(scheme.endDate);
                const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                const dailyDose = scheme.morning + scheme.noon + scheme.evening + scheme.night;
                totalAmount += dailyDose * days;
                
                const notation = `${scheme.morning}-${scheme.noon}-${scheme.evening}${scheme.night > 0 ? '-' + scheme.night : ''}`;
                dosageInstructions.push(`${startDate.toLocaleDateString('de-DE')}-${endDate.toLocaleDateString('de-DE')}: ${notation}`);
            });
            
            const concentrationValue = parseFloat(medication.concentration);
            const totalSubstance = totalAmount * concentrationValue;
            
            // Page 1: Certificate
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'bold');
            pdf.text('Bescheinigung f√ºr das Mitf√ºhren von Bet√§ubungsmitteln', 105, 20, { align: 'center' });
            pdf.text('im Rahmen einer √§rztlichen Behandlung', 105, 26, { align: 'center' });
            pdf.text('- Artikel 75 des Schengener Durchf√ºhrungsabkommens -', 105, 32, { align: 'center' });
            
            let y = 45;
            
            // Section A - Doctor
            pdf.setFontSize(10);
            pdf.rect(10, y, 190, 45);
            pdf.setFont(undefined, 'bold');
            pdf.text('A - Verschreibender Arzt:', 12, y + 5);
            pdf.setFont(undefined, 'normal');
            
            pdf.text('(1) Name, Vorname, Telefon:', 12, y + 12);
            pdf.text(`${appData.currentDoctor.title} ${appData.currentDoctor.lastname}, ${appData.currentDoctor.firstname}, ${appData.currentDoctor.phone}`, 70, y + 12);
            
            pdf.text('(2) Anschrift:', 12, y + 19);
            pdf.text(appData.currentDoctor.address, 70, y + 19);
            
            pdf.text('(3) Stempel des Arztes:', 12, y + 30);
            pdf.rect(70, y + 25, 40, 15);
            pdf.text('Datum:', 115, y + 30);
            pdf.rect(130, y + 25, 30, 15);
            pdf.text('Unterschrift:', 165, y + 30);
            pdf.rect(165, y + 25, 30, 15);
            
            y += 50;
            
            // Section B - Patient
            pdf.rect(10, y, 190, 65);
            pdf.setFont(undefined, 'bold');
            pdf.text('B - Patient:', 12, y + 5);
            pdf.setFont(undefined, 'normal');
            
            pdf.text('(4) Name, (5) Vorname:', 12, y + 12);
            pdf.text(`${appData.currentPatient.lastname}, ${appData.currentPatient.firstname}`, 70, y + 12);
            
            pdf.text('(5) Nr. des Passes/Ausweises:', 12, y + 19);
            pdf.text(appData.currentPatient.passport, 70, y + 19);
            
            pdf.text('(6) Geburtsort:', 12, y + 26);
            pdf.text(appData.currentPatient.birthplace, 70, y + 26);
            
            pdf.text('(7) Geburtsdatum:', 115, y + 26);
            pdf.text(new Date(appData.currentPatient.birthdate).toLocaleDateString('de-DE'), 150, y + 26);
            
            pdf.text('(8) Staatsangeh√∂rigkeit:', 12, y + 33);
            pdf.text(appData.currentPatient.nationality, 70, y + 33);
            
            pdf.text('(9) Geschlecht:', 115, y + 33);
            pdf.text(appData.currentPatient.gender, 150, y + 33);
            
            pdf.text('(10) Wohnanschrift:', 12, y + 40);
            pdf.text(`${appData.currentPatient.street}, ${appData.currentPatient.zip} ${appData.currentPatient.city}`, 70, y + 40);
            
            pdf.text('(11) Dauer der Reise in Tagen:', 12, y + 47);
            pdf.text(appData.travelData.duration.toString(), 70, y + 47);
            
            pdf.text('(12) G√ºltigkeitsdauer der Erlaubnis:', 12, y + 54);
            pdf.text(`${new Date(appData.travelData.start).toLocaleDateString('de-DE')} - ${new Date(appData.travelData.end).toLocaleDateString('de-DE')}`, 70, y + 54);
            
            y += 70;
            
            // Section C - Medication
            pdf.rect(10, y, 190, 70);
            pdf.setFont(undefined, 'bold');
            pdf.text('C - Verschriebenes Arzneimittel:', 12, y + 5);
            pdf.setFont(undefined, 'normal');
            
            pdf.text('(13) Handelsbezeichnung:', 12, y + 12);
            pdf.text(medication.name, 70, y + 12);
            
            pdf.text('(14) Darreichungsform:', 12, y + 19);
            pdf.text(medication.form, 70, y + 19);
            
            pdf.text('(15) Internationale Bezeichnung:', 12, y + 26);
            pdf.text(medication.substance, 70, y + 26);
            
            pdf.text('(16) Wirkstoff-Konzentration:', 12, y + 33);
            pdf.text(medication.concentration, 70, y + 33);
            
            pdf.text('(17) Gebrauchsanweisung:', 12, y + 40);
            const instructionText = dosageInstructions.join('; ');
            const splitInstructions = pdf.splitTextToSize(instructionText, 120);
            pdf.text(splitInstructions, 70, y + 40);
            
            pdf.text('(18) Gesamtwirkstoffmenge:', 12, y + 47);
            pdf.text(`${totalSubstance} mg`, 70, y + 47);
            
            pdf.text('(19) Reichdauer der Verschreibung:', 12, y + 54);
            pdf.text(`${appData.travelData.duration} Tage`, 70, y + 54);
            
            pdf.text('(20) Anmerkungen:', 12, y + 61);
            pdf.text(`Gesamtmenge: ${totalAmount} ${medication.form}`, 70, y + 61);
            
            y += 75;
            
            // Section D - Authority
            if (y + 45 > 297) {
                pdf.addPage();
                y = 20;
            }
            
            pdf.rect(10, y, 190, 45);
            pdf.setFont(undefined, 'bold');
            pdf.text('D - F√ºr die Beglaubigung zust√§ndige Beh√∂rde:', 12, y + 5);
            pdf.setFont(undefined, 'normal');
            
            pdf.text('(21) Bezeichnung:', 12, y + 12);
            pdf.line(50, y + 12, 195, y + 12);
            
            pdf.text('(22) Anschrift, Telefon:', 12, y + 19);
            pdf.line(50, y + 19, 195, y + 19);
            
            pdf.text('(23) Stempel der Beh√∂rde:', 12, y + 30);
            pdf.rect(70, y + 25, 40, 15);
            pdf.text('Datum:', 115, y + 30);
            pdf.rect(130, y + 25, 30, 15);
            pdf.text('Unterschrift:', 165, y + 30);
            pdf.rect(165, y + 25, 30, 15);
            
            // Page 2: International Legend
            pdf.addPage();
            pdf.setFontSize(11);
            pdf.setFont(undefined, 'bold');
            pdf.text('International Legend / L√©gende Internationale', 105, 20, { align: 'center' });
            
            pdf.setFontSize(9);
            pdf.setFont(undefined, 'normal');
            
            // English column
            let legendY = 35;
            pdf.setFont(undefined, 'bold');
            pdf.text('English:', 20, legendY);
            pdf.setFont(undefined, 'normal');
            legendY += 7;
            
            const englishLegend = [
                'A - Prescribing doctor',
                '(1) name, first name, phone',
                '(2) address',
                '(3) stamp, date, signature of doctor',
                '',
                'B - Patient',
                '(4) name, first name',
                '(5) no. of passport or ID',
                '(6) place of birth',
                '(7) date of birth',
                '(8) nationality',
                '(9) sex',
                '(10) address',
                '(11) duration of travel in days',
                '(12) validity from/to - max. 30 days',
                '',
                'C - Prescribed drug',
                '(13) trade name',
                '(14) dosage form',
                '(15) international name of substance',
                '(16) concentration',
                '(17) instructions for use',
                '(18) total quantity of substance',
                '(19) duration - max. 30 days',
                '(20) remarks',
                '',
                'D - Accrediting authority',
                '(21) designation',
                '(22) address, phone',
                '(23) stamp, date, signature'
            ];
            
            englishLegend.forEach(line => {
                if (line === '') {
                    legendY += 3;
                } else {
                    pdf.text(line, 20, legendY);
                    legendY += 5;
                }
            });
            
            // French column
            legendY = 35;
            pdf.setFont(undefined, 'bold');
            pdf.text('Fran√ßais:', 110, legendY);
            pdf.setFont(undefined, 'normal');
            legendY += 7;
            
            const frenchLegend = [
                'A - M√©decin prescripteur',
                '(1) nom, pr√©nom, t√©l√©phone',
                '(2) adresse',
                '(3) cachet, date, signature',
                '',
                'B - Patient',
                '(4) nom, pr√©nom',
                '(5) n¬∞ du passeport ou document',
                '(6) lieu de naissance',
                '(7) date de naissance',
                '(8) nationalit√©',
                '(9) sexe',
                '(10) adresse',
                '(11) dur√©e du voyage en jours',
                '(12) validit√© du/au - max. 30 jours',
                '',
                'C - M√©dicament prescrit',
                '(13) nom commercial',
                '(14) forme pharmaceutique',
                '(15) d√©nomination internationale',
                '(16) concentration',
                '(17) mode d\'emploi',
                '(18) quantit√© totale',
                '(19) dur√©e - max. 30 jours',
                '(20) remarques',
                '',
                'D - Autorit√© qui authentifie',
                '(21) d√©signation',
                '(22) adresse, t√©l√©phone',
                '(23) sceau, date, signature'
            ];
            
            frenchLegend.forEach(line => {
                if (line === '') {
                    legendY += 3;
                } else {
                    pdf.text(line, 110, legendY);
                    legendY += 5;
                }
            });
            
            return pdf;
        }
        
        function createMedicationPlanPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('l', 'mm', 'a4'); // Landscape orientation
            
            // Header
            pdf.setFontSize(16);
            pdf.setFont(undefined, 'bold');
            pdf.text('Medikationsplan f√ºr BTM-Reise', 148, 20, { align: 'center' });
            
            // Patient and Doctor info
            pdf.setFontSize(10);
            pdf.setFont(undefined, 'normal');
            
            // Patient info box
            pdf.rect(10, 30, 135, 30);
            pdf.setFont(undefined, 'bold');
            pdf.text('Patient:', 12, 36);
            pdf.setFont(undefined, 'normal');
            pdf.text(`${appData.currentPatient.firstname} ${appData.currentPatient.lastname}`, 12, 42);
            pdf.text(`Geb.: ${new Date(appData.currentPatient.birthdate).toLocaleDateString('de-DE')}`, 12, 48);
            pdf.text(`${appData.currentPatient.street}, ${appData.currentPatient.zip} ${appData.currentPatient.city}`, 12, 54);
            
            // Doctor info box
            pdf.rect(152, 30, 135, 30);
            pdf.setFont(undefined, 'bold');
            pdf.text('Verschreibender Arzt:', 154, 36);
            pdf.setFont(undefined, 'normal');
            pdf.text(`${appData.currentDoctor.title} ${appData.currentDoctor.firstname} ${appData.currentDoctor.lastname}`, 154, 42);
            pdf.text(`Tel: ${appData.currentDoctor.phone}`, 154, 48);
            pdf.text(appData.currentDoctor.address, 154, 54);
            
            // Travel info
            pdf.setFont(undefined, 'bold');
            pdf.text('Reisezeitraum:', 12, 68);
            pdf.setFont(undefined, 'normal');
            pdf.text(`${new Date(appData.travelData.start).toLocaleDateString('de-DE')} - ${new Date(appData.travelData.end).toLocaleDateString('de-DE')} (${appData.travelData.duration} Tage)`, 45, 68);
            
            // Medication table
            let y = 80;
            
            // Table header
            pdf.setFillColor(102, 126, 234);
            pdf.rect(10, y, 277, 8, 'F');
            pdf.setTextColor(255, 255, 255);
            pdf.setFont(undefined, 'bold');
            pdf.text('Zeitraum', 12, y + 5);
            pdf.text('Arzneimittel', 60, y + 5);
            pdf.text('Einnahmeanweisung', 140, y + 5);
            pdf.text('Tagesdosis', 200, y + 5);
            pdf.text('Gesamtmenge', 240, y + 5);
            
            pdf.setTextColor(0, 0, 0);
            pdf.setFont(undefined, 'normal');
            y += 10;
            
            let totalsByMedication = {};
            
            // Table content
            appData.selectedMedications.forEach(med => {
                const schemes = appData.dosageSchemes[med.id] || [{
                    startDate: appData.travelData.start,
                    endDate: appData.travelData.end,
                    morning: 0,
                    noon: 0,
                    evening: 0,
                    night: 0
                }];
                
                schemes.forEach(scheme => {
                    const startDate = new Date(scheme.startDate);
                    const endDate = new Date(scheme.endDate);
                    const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                    const dailyDose = scheme.morning + scheme.noon + scheme.evening + scheme.night;
                    const totalAmount = dailyDose * days;
                    
                    const dosageNotation = `${scheme.morning}-${scheme.noon}-${scheme.evening}${scheme.night > 0 ? '-' + scheme.night : ''}`;
                    
                    // Draw row
                    pdf.rect(10, y - 2, 277, 8);
                    pdf.text(`${startDate.toLocaleDateString('de-DE')} - ${endDate.toLocaleDateString('de-DE')}`, 12, y + 2);
                    pdf.text(`${med.name} ${med.concentration}`, 60, y + 2);
                    pdf.text(dosageNotation, 140, y + 2);
                    pdf.text(`${dailyDose} ${med.form}/Tag`, 200, y + 2);
                    pdf.text(`${totalAmount} ${med.form}`, 240, y + 2);
                    
                    y += 8;
                    
                    const key = `${med.name} ${med.concentration}`;
                    totalsByMedication[key] = (totalsByMedication[key] || 0) + totalAmount;
                    
                    // Add new page if needed
                    if (y > 180) {
                        pdf.addPage();
                        y = 20;
                    }
                });
            });
            
            // Summary
            y += 10;
            pdf.setFont(undefined, 'bold');
            pdf.text('Packhilfe - Gesamtmengen:', 12, y);
            pdf.setFont(undefined, 'normal');
            y += 8;
            
            for (const [med, total] of Object.entries(totalsByMedication)) {
                pdf.text(`‚Ä¢ ${med}: ${total} St√ºck`, 15, y);
                y += 6;
            }
            
            // Footer
            y = 190;
            pdf.setFontSize(8);
            pdf.setFont(undefined, 'italic');
            pdf.text(`Erstellt am: ${new Date().toLocaleDateString('de-DE')} ${new Date().toLocaleTimeString('de-DE')}`, 12, y);
            pdf.text('Dieser Medikationsplan ist Teil der BTM-Reisebescheinigung nach Artikel 75 des Schengener Abkommens', 12, y + 5);
            
            return pdf;
        }
        
        function downloadAllPDFs() {
            if (generatedPDFs.length === 0) {
                alert('Bitte erst PDFs generieren!');
                return;
            }
            
            generatedPDFs.forEach(pdfData => {
                pdfData.pdf.save(pdfData.name);
            });
            
            alert(`${generatedPDFs.length} PDFs wurden heruntergeladen!`);
        }
        
        function generateCertificates() {
            // Legacy function for compatibility
            generatePDFs();
        }
        
        function printCertificates() {
            alert('Bitte verwenden Sie die PDF-Download-Funktion zum Drucken der Dokumente.');
        }
        
        // Data management functions
        function saveToStorage() {
            // In a real app, this would use localStorage
            // For now, we just keep it in memory
            console.log('Data saved:', appData);
        }
        
        function loadFromStorage() {
            // In a real app, this would load from localStorage
            console.log('Data loaded:', appData);
        }
        
        function updateSavedDataDisplay() {
            // Update patients
            const patientsContainer = document.getElementById('saved-patients');
            if (appData.patients.length === 0) {
                patientsContainer.innerHTML = '<p>Keine gespeicherten Patienten</p>';
            } else {
                patientsContainer.innerHTML = appData.patients.map(patient => `
                    <div class="saved-data-card">
                        <h4>${patient.firstname} ${patient.lastname}</h4>
                        <p>Geboren: ${new Date(patient.birthdate).toLocaleDateString('de-DE')}</p>
                        <p>Adresse: ${patient.zip} ${patient.city}</p>
                        <button class="btn btn-secondary btn-small" onclick="selectPatient(${patient.id})">
                            Ausw√§hlen
                        </button>
                    </div>
                `).join('');
            }
            
            // Update doctors
            const doctorsContainer = document.getElementById('saved-doctors');
            if (appData.doctors.length === 0) {
                doctorsContainer.innerHTML = '<p>Keine gespeicherten √Ñrzte</p>';
            } else {
                doctorsContainer.innerHTML = appData.doctors.map(doctor => `
                    <div class="saved-data-card">
                        <h4>${doctor.title} ${doctor.firstname} ${doctor.lastname}</h4>
                        <p>Telefon: ${doctor.phone}</p>
                        <p>Adresse: ${doctor.address}</p>
                        <button class="btn btn-secondary btn-small" onclick="selectDoctor(${doctor.id})">
                            Ausw√§hlen
                        </button>
                    </div>
                `).join('');
            }
            
            // Update links
            const linksContainer = document.getElementById('saved-links');
            if (appData.patientDoctorLinks.length === 0) {
                linksContainer.innerHTML = '<p>Keine Verkn√ºpfungen vorhanden</p>';
            } else {
                linksContainer.innerHTML = appData.patientDoctorLinks.map(link => {
                    const patient = appData.patients.find(p => p.id === link.patientId);
                    const doctor = appData.doctors.find(d => d.id === link.doctorId);
                    
                    if (!patient || !doctor) return '';
                    
                    return `
                        <div class="saved-data-card">
                            <h4>Verkn√ºpfung</h4>
                            <p><strong>Patient:</strong> ${patient.firstname} ${patient.lastname}</p>
                            <p><strong>Arzt:</strong> ${doctor.title} ${doctor.firstname} ${doctor.lastname}</p>
                            <button class="btn btn-secondary btn-small" onclick="loadLink(${link.patientId}, ${link.doctorId})">
                                Laden
                            </button>
                        </div>
                    `;
                }).join('');
            }
        }
        
        function selectPatient(id) {
            const patient = appData.patients.find(p => p.id === id);
            if (patient) {
                loadPatient(patient);
                // Switch to patient tab
                document.querySelector('[data-tab="patient"]').click();
            }
        }
        
        function selectDoctor(id) {
            const doctor = appData.doctors.find(d => d.id === id);
            if (doctor) {
                loadDoctor(doctor);
                // Switch to doctor tab
                document.querySelector('[data-tab="doctor"]').click();
            }
        }
        
        function loadLink(patientId, doctorId) {
            selectPatient(patientId);
            selectDoctor(doctorId);
            alert('Verkn√ºpfung wurde geladen!');
        }
        
        function exportData() {
            const dataToExport = {
                patient: appData.currentPatient,
                doctor: appData.currentDoctor,
                medications: appData.selectedMedications,
                travelData: appData.travelData,
                dosageSchemes: appData.dosageSchemes
            };
            
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `btm-reise-${Date.now()}.json`;
            link.click();
        }
        
        function exportAllData() {
            const dataStr = JSON.stringify(appData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `btm-app-data-${Date.now()}.json`;
            link.click();
        }
        
        function importData() {
            document.getElementById('import-file').click();
        }
        
        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Check if it's full app data or single export
                    if (importedData.patients && Array.isArray(importedData.patients)) {
                        // Full app data
                        appData = {...appData, ...importedData};
                    } else {
                        // Single export
                        if (importedData.patient) appData.currentPatient = importedData.patient;
                        if (importedData.doctor) appData.currentDoctor = importedData.doctor;
                        if (importedData.medications) appData.selectedMedications = importedData.medications;
                        if (importedData.travelData) appData.travelData = importedData.travelData;
                        if (importedData.dosageSchemes) appData.dosageSchemes = importedData.dosageSchemes;
                    }
                    
                    updateSavedDataDisplay();
                    updateSelectedMedications();
                    updateDosageSchemes();
                    alert('Daten wurden erfolgreich importiert!');
                } catch (error) {
                    alert('Fehler beim Importieren der Daten!');
                    console.error(error);
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }
        
        function clearAllData() {
            if (confirm('Wirklich alle Daten l√∂schen?')) {
                appData = {
                    patients: [],
                    doctors: [],
                    medications: [],
                    selectedMedications: [],
                    patientDoctorLinks: [],
                    currentPatient: null,
                    currentDoctor: null,
                    travelData: null,
                    dosageSchemes: {}
                };
                updateSavedDataDisplay();
                updateSelectedMedications();
                updateDosageSchemes();
                alert('Alle Daten wurden gel√∂scht!');
            }
        }
        
        // Initialize
        updateSavedDataDisplay();
        
        // Add demo data for testing
        function loadDemoData() {
            appData.currentPatient = {
                id: 1,
                lastname: "Mustermann",
                firstname: "Max",
                passport: "L3GL30CLN",
                birthplace: "M√ºnchen",
                birthdate: "1985-03-15",
                nationality: "Deutsch",
                gender: "m√§nnlich",
                street: "Hauptstra√üe 42",
                zip: "92353",
                city: "Postbauer-Heng"
            };
            
            appData.currentDoctor = {
                id: 1,
                title: "Dr. med.",
                lastname: "Schmidt",
                firstname: "Thomas",
                phone: "0911/123456",
                address: "Bahnhofstra√üe 15, 90518 Altdorf bei N√ºrnberg"
            };
            
            appData.patients.push(appData.currentPatient);
            appData.doctors.push(appData.currentDoctor);
            
            // Auto-fill forms with demo data
            loadPatient(appData.currentPatient);
            loadDoctor(appData.currentDoctor);
            
            updateSavedDataDisplay();
        }
        
        // Load demo data on startup for testing
        loadDemoData();
    </script>
</body>
</html>
